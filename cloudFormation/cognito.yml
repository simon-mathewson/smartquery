Resources:
  CognitoIdentityPoolDabase:
    Type: AWS::Cognito::IdentityPool
    Properties:
      AllowUnauthenticatedIdentities: true
      IdentityPoolName: dabase

  ManagedPolicyCognito:
    Type: "AWS::IAM::ManagedPolicy"
    Properties:
      Path: "/service-role/"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Resource: "*"
            Action: 
              - "mobiletargeting:PutEvents"
              - "mobiletargeting:UpdateEndpoint"
              - "mobileanalytics:PutEvents"
            Effect: "Allow"

  IAMRoleCognito:
    Type: "AWS::IAM::Role"
    Properties:
      Path: "/service-role/"
      ManagedPolicyArns:
        - !Ref ManagedPolicyCognito
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
        - Action: "sts:AssumeRoleWithWebIdentity"
          Effect: "Allow"
          Principal:
            Federated: "cognito-identity.amazonaws.com"
          Condition:
            StringEquals:
              'cognito-identity.amazonaws.com:aud': !Sub
                - "eu-central-1:${IdentityPoolId}"
                - IdentityPoolId: !GetAtt CognitoIdentityPoolDabase.Id
            'ForAnyValue:StringLike':
              'cognito-identity.amazonaws.com:amr': "unauthenticated"

  CognitoIdentityPoolDabaseRoleAttachment:
    Type: AWS::Cognito::IdentityPoolRoleAttachment
    Properties:
      IdentityPoolId: !Ref CognitoIdentityPoolDabase
      Roles:
        unauthenticated: !GetAtt IAMRoleCognito.Arn

Outputs:
  CognitoIdentityPoolId:
    Description: "Cognito Identity Pool ID"
    Value: !Ref CognitoIdentityPoolDabase
    Export:
      Name: CognitoIdentityPoolId

